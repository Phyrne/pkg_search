#! /usr/local/bin/bash

# Sanity check to ensure user is using FTP
if [[ $(echo "$PKG_PATH" | grep -i 'ftp' | wc -l) -eq 0 ]]; then
    echo -e "\nIt doesn't look like you're using FTP for your packages.\npkg_search currently only supports FTP\n"
    exit 1
fi

# Function to search the user's defined package path (currently only FTP supported) and provide a numbered list.
search() {
	curl -s $PKG_PATH | awk '{print$9}' | sed 's/\.tgz//' | grep $1 | grep -n $1
}

# Variable to calculate the total number of packages containing the search string
TOTAL=$(search $1 | wc -l | awk '{print$1}')

# Search the package path with the search function and calculate the total number of results
echo -e "\nQuerying \e[38;4;34m$PKG_PATH\e[0m for \e[38;33m'$1'\e[0m\n "

search $1

# If no results are returned exit
if [[ $TOTAL -lt 1 ]]; then
  echo -e "No packages containing the string '$1' were found!\n\nExiting...\n"
  exit 1
fi

echo -e "\nThere were \e[38;32m$TOTAL\e[0m packages found\n"

# Prompt the user for a package to install
while :
do
  read -r -p "Which would you like to install? " ANSWER
    case $ANSWER in
      [0-9]|[0-9][0-9]|[0-9][0-9][0-9]|[0-9][0-9][0-9][0-9])
          if [[ $ANSWER -gt $TOTAL || $ANSWER == '0' ]]; then
            echo -e "\nPlease enter a number within the result range...\n"
          else
            SELECTED=$(search $1 | grep "^$ANSWER" | cut -d ':' -f2)
            echo -e "\n\e[38;34mInstalling $SELECTED\e[0m\n"
            sudo pkg_add $SELECTED;
            echo -e "\n$SELECTED installed successfully!"
            break
          fi
          ;;
       *)
          echo -e "\nPlease enter the number of the package you'd like to install....\n"
    esac
done
